import win.ui; import HJDL; import mouse; import win.ui.grid; import fsys.dlg; import process; import uConfig; import win.dlg.message; import skin.sharp; skin.sharp.attach("\res\Longhorn.she"); var logTab = win.loadForm("\dlg\login\login.aardio").doModal() if(!logTab || logTab == null){return}; var user = logTab[1]; var session = logTab[2]; /* console.log(session) user,session = "qd7600017107","67B7671EA10D9F36"; */ thread.set("user", user) thread.set("session", session) /*DSG{{*/ mainForm = win.form(cls="HJ_WIN";text="话机代理认证助手";right=984;bottom=596;border="dialog frame";max=false) mainForm.add( groupbox={cls="groupbox";text="实名手机号码";left=18;top=10;right=272;bottom=534;edge=1;z=2}; groupbox2={cls="groupbox";text="身份证信息";left=282;top=10;right=970;bottom=300;edge=1;z=6}; groupbox3={cls="groupbox";text="日志";left=282;top=310;right=970;bottom=544;edge=1;z=8}; groupbox4={cls="groupbox";left=18;top=553;right=754;bottom=584;edge=1;z=1}; kssm={cls="button";text="开始实名";left=779;top=557;right=868;bottom=586;z=4}; listview={cls="listview";left=28;top=31;right=262;bottom=521;asel=false;edge=1;vscroll=1;z=3}; listview2={cls="listview";left=292;top=30;right=960;bottom=287;edge=1;z=7}; listview3={cls="listview";left=292;top=327;right=960;bottom=532;edge=1;z=9}; progress={cls="progress";left=495;top=147;right=756;bottom=177;edge=1;hide=1;max=100;min=0;z=20}; s1={cls="static";text="未开始";left=69;top=564;right=152;bottom=582;align="center";aw=1;font=LOGFONT(weight=700);transparent=1;z=14}; s2={cls="static";text="25";left=252;top=564;right=284;bottom=584;align="center";aw=1;font=LOGFONT(weight=700);transparent=1;z=15}; s3={cls="static";text="25";left=362;top=564;right=394;bottom=582;align="center";aw=1;font=LOGFONT(weight=700);transparent=1;z=16}; s4={cls="static";text="25";left=472;top=564;right=504;bottom=582;align="center";aw=1;font=LOGFONT(weight=700);transparent=1;z=17}; s5={cls="static";text="510233199002231565";left=610;top=564;right=737;bottom=582;aw=1;font=LOGFONT(weight=700);transparent=1;z=19}; static={cls="static";text="可用身份信息：";left=157;top=564;right=249;bottom=582;transparent=1;z=11}; static1={cls="static";text="状态：";left=27;top=564;right=67;bottom=582;aw=1;transparent=1;z=10}; static2={cls="static";text="手机号：";left=306;top=564;right=360;bottom=582;transparent=1;z=12}; static3={cls="static";text="已实名：";left=417;top=564;right=472;bottom=582;transparent=1;z=13}; static6={cls="static";text="当前身份证：";left=522;top=564;right=610;bottom=582;transparent=1;z=18}; tzsm={cls="button";text="停止实名";left=881;top=557;right=970;bottom=586;bgcolor=255;color=8388736;z=5} ) /*}}*/ var HJ = HJDL(); var msgDlg = win.dlg.message(mainForm); //导入phone upPhone = function(){ mainForm.s1.text="手机号导入中" mainForm.listview3.clear()//清空日志列表 var numPath=fsys.dlg.open("实名号码TXT|*.txt","选择要导入的号码文件",,mainForm.hwnd) if(!numPath){ mainForm.s1.text="未启动" return ; } var tmp=string.load(numPath) var numStr=string.split(tmp,'<\r\n>'); var numTab ={}; var bs=false; var pNum =0 ; for(i=1;#numStr;1){ var numTmp = numStr[i] if(!uConfig.loadIni(user) || string.indexOf(tmp,uConfig.loadIni(user))==null){ if(numTmp!=""){ mainForm.listview.addItem({text={i;numTmp;"未登记"}}) pNum++; } }else { if(numTmp!=""){ if(bs){ mainForm.listview.addItem({text={i;numTmp;"未登记"}}) }else { mainForm.listview.addItem({text={i;numTmp;"已实名"}}) } if(numTmp==uConfig.loadIni(user)){ bs=true } pNum++; } } } mainForm.s1.text="未启动" mainForm.s3.text=pNum//状态栏 手机号数量 } upInfo = function(){ mainForm.s1.text="身份证导入中" mainForm.listview3.clear()//清空日志列表 var jsTab=HJ.readCard(mainForm.hwnd) if(#jsTab=0){ mainForm.s1.text="未启动" return ; } thread.set("jsTab", jsTab) var infoPath = win.invoke( function(mainForm){ import win; import console; import HJDL; var HJ = HJDL() var jsTab = thread.get("jsTab"); mainForm.progress.hide=false//显示进度条 mainForm.listview2.disabled=true mainForm.progress.pos=0 for(i=1;#jsTab;1){ mainForm.progress.pos=100/#jsTab*i //进度条 var jsStr,savaStr,infoStr="","",{}; var isHave=fsys.searchFile("info.txt",jsTab[i][1]) if(isHave){ jsStr = string.load(jsTab[i][1]+"info.txt"); //读取"info.txt" jsStr = string.fromto(jsStr,65001,65001) jsStr = string.split(jsStr,'<\r\n>') infoStr = { name = jsStr[1]; gender = jsStr[2]; cardNo = jsStr[3]; address = jsStr[4]; birthday = jsStr[5]; validate = jsStr[6]; nation = jsStr[7]; authortity = jsStr[8]; } jsStr = web.json.strip(infoStr) }else { jsStr = HJ.getCardInfo(jsTab[i][3],jsTab[i][4]);//读取身份证 } //console.dump(jsStr) if(jsStr){ mainForm.listview2.addItem({//写入listview text={mainForm.listview2.count+1; jsStr.name; jsStr.cardNo; jsStr.gender; jsStr.nation; jsStr.birthday; jsStr.address; jsStr.authortity; jsStr.validate; jsTab[i][5]//目录下名称 }}) var savaStr=jsStr.name+'\r\n'+jsStr.gender+'\r\n'+jsStr.cardNo+'\r\n'+jsStr.address+'\r\n'+jsStr.birthday+'\r\n'+jsStr.validate+'\r\n'+jsStr.nation+'\r\n'+jsStr.authortity savaStr=string.fromto(savaStr,65001,65001) string.save(jsTab[i][1]+"\info.txt",savaStr) }else { mainForm.listview3.addItem({text={jsTab[i][5];"";"读取证件信息失败。"} } ) } } mainForm.listview2.disabled=false mainForm.progress.hide=true mainForm.progress.pos=0 return jsTab[1][6]; },mainForm ) mainForm.s1.text="身份证导入中" return infoPath; } init=function(){ mainForm.s1.text="未启动" for(i=2;5;1){ mainForm["s"+i].text="0" } } init2=function(){ mainForm.listview3.clear() mainForm.s1.text="未启动" mainForm.s4.text="0" mainForm.s5.text="0" } upInfoLis = function(mainForm){//更新实名列表 mainForm.listview2.delItem(1) for(i=1;mainForm.listview2.count;1){//更新序号 mainForm.listview2.setItemText(i,i,1) } mainForm.s2.text=mainForm.listview2.count//更新状态栏显示数量 } /*列表框{{*/ setPhoneLis=function (){ mainForm.listview.clear() //创建弹出菜单 popmenu1 = win.ui.popmenu(mainForm); popmenu1.add('导入号码',function(id){ mainForm.listview.clear() upPhone(); }); popmenu1.add() popmenu1.add('删除选中',function(id){ var ckTmp=mainForm.listview.selected for(e=1;#ckTmp;1){ mainForm.listview.delItem(ckTmp[1]) ckTmp=mainForm.listview.selected } for(i=1;mainForm.listview.count;1){ mainForm.listview.setItemText(i,i,1) } mainForm.s3.text=mainForm.listview.count//更新状态栏显示数量 });popmenu1.add() popmenu1.add('更改列表状态为"未登记"',function(id){ if(!msgDlg.ask("确定要修改吗?")){ return } else { for(i=1;mainForm.listview.count;1){ mainForm.listview.setItemText("未登记",i,3) } }; }); popmenu1.add('删除进度节点',function(id){ if(!msgDlg.ask("确定要删除吗?")){ return } else { uConfig.saveIni(user,"") }; }); popmenu1.add() popmenu1.add('清空号码列表',function(id){ mainForm.listview.clear() }); //双击listview控件添加下面的代码 var grid = win.ui.grid(mainForm.listview);//创建数据视图 可编辑 grid.readonlyColums = { [1] = true;[2] = true;[3] = true;};//设置禁止编辑的列 mainForm.listview.onnotify = function(id,code,ptr){ if(code==0xFFFFFFFB/*_NM_RCLICK*/){ var x,y = mouse.getPos() popmenu1.popup(x,y,true);//弹出菜单 } } mainForm.listview.insertColumn("序号",50,,0x0/*_LVCFMT_LEFT*/) mainForm.listview.insertColumn("手机号",100,,0x2/*_LVCFMT_CENTER*/) mainForm.listview.insertColumn("状态",60,,0x2/*_LVCFMT_CENTER*/) //mainForm.listview.addItem({text={"1";"13800138000";"未登记"} } ) } setCardLis=function (){ mainForm.listview2.clear() //创建弹出菜单 popmenu2 = win.ui.popmenu(mainForm); popmenu2.add('导入身份证',function(id){ //mainForm.listview2.clear() openPath = upInfo(); thread.set("openPath", openPath) mainForm.s2.text=mainForm.listview2.count//状态栏 可用身份证数量 }); popmenu2.add() popmenu2.add('编辑选中行',function(id){ var ckTmp=mainForm.listview2.selected if(#ckTmp!=1){ msgDlg.err("选择一条记录进行编辑。") }else { var editWin = mainForm.loadForm("\dlg\编辑\editCard.aardio"); for(i=2;9;1){ var sTmp=mainForm.listview2.getItemText(ckTmp[1],i) editWin["t"+i-1].text=sTmp } var tbStr=editWin.doModal() var savaStr ="" ; if(#tbStr!=0){ for(j=2;9;1){ mainForm.listview2.setItemText(tbStr[j-1],ckTmp[1],j) } var nameDir = mainForm.listview2.getItemText(ckTmp[1],10); //目录姓名 var savaStr=tbStr[1]+'\r\n'+tbStr[3]+'\r\n'+tbStr[2]+'\r\n'+tbStr[6]+'\r\n'+tbStr[5]+'\r\n'+tbStr[8]+'\r\n'+tbStr[4]+'\r\n'+tbStr[7] savaStr=string.fromto(savaStr,65001,65001) string.save(openPath+nameDir+"\info.txt",savaStr) } } });popmenu2.add() popmenu2.add('删除选中行',function(id){ var ckTmp=mainForm.listview2.selected for(e=1;#ckTmp;1){ mainForm.listview2.delItem(ckTmp[1]) ckTmp=mainForm.listview2.selected } for(i=1;mainForm.listview2.count;1){ mainForm.listview2.setItemText(i,i,1) } mainForm.s2.text=mainForm.listview2.count//更新状态栏显示数量 });popmenu2.add() popmenu2.add('清空列表',function(id){ mainForm.listview2.clear() }); //双击listview2控件添加下面的代码 var grid = win.ui.grid(mainForm.listview2);//创建数据视图 可编辑 grid.readonlyColums = {[1] = true;};//设置禁止编辑的列 mainForm.listview2.onnotify = function(id,code,ptr){ if(code==0xFFFFFFFB/*_NM_RCLICK*/){ var x,y = mouse.getPos() popmenu2.popup(x,y,true);//弹出菜单 } } mainForm.listview2.insertColumn("序号",50,,0x0/*_LVCFMT_LEFT*/) mainForm.listview2.insertColumn("姓名",65,,0x2/*_LVCFMT_CENTER*/) mainForm.listview2.insertColumn("身份证号码",140,,0x2/*_LVCFMT_CENTER*/) mainForm.listview2.insertColumn("性别",40,,0x2/*_LVCFMT_CENTER*/) mainForm.listview2.insertColumn("民族",40,,0x2/*_LVCFMT_CENTER*/) mainForm.listview2.insertColumn("出生日期",80,,0x2/*_LVCFMT_CENTER*/) mainForm.listview2.insertColumn("住址",400,,0x2/*_LVCFMT_CENTER*/) mainForm.listview2.insertColumn("签证机关",160,,0x2/*_LVCFMT_CENTER*/) mainForm.listview2.insertColumn("有效期",140,,0x2/*_LVCFMT_CENTER*/) mainForm.listview2.insertColumn("目录",1,,0x2/*_LVCFMT_CENTER*/) //mainForm.listview2.addItem({text={"2";"李峰发";"411021199554541216";"男";"汉";"19880123";"广东省广州市杜建国肯定是噶水电费大方的";"反射发公安局";"20180123 - 20181523"} } ) } setLogLis=function (){ mainForm.listview3.clear() //创建弹出菜单 popmenu3 = win.ui.popmenu(mainForm); popmenu3.add('删除选中记录',function(id){ var ckTmp=mainForm.listview3.selected for(e=1;#ckTmp;1){ mainForm.listview3.delItem(ckTmp[1]) ckTmp=mainForm.listview3.selected } });popmenu3.add() popmenu3.add('清空日志列表',function(id){ mainForm.listview3.clear() }); //双击listview3控件添加下面的代码 var grid = win.ui.grid(mainForm.listview3);//创建数据视图 可编辑 grid.readonlyColums = {[1] = true;};//设置禁止编辑的列 mainForm.listview3.onnotify = function(id,code,ptr){ if(code==0xFFFFFFFB/*_NM_RCLICK*/){ var x,y = mouse.getPos() popmenu3.popup(x,y,true);//弹出菜单 } } mainForm.listview3.adjust = function(cx,cy){ mainForm.listview3.fillParent(3/*列序号*/); } mainForm.listview3.insertColumn("姓名",65,,0x2/*_LVCFMT_CENTER*/) mainForm.listview3.insertColumn("身份证号码",140,,0x2/*_LVCFMT_CENTER*/) mainForm.listview3.insertColumn("输出日志",100,,0x2/*_LVCFMT_CENTER*/) //mainForm.listview3.addItem({text={"1";"李发";"511021199554541216";"错误提示"} } ) //mainForm.listview3.addItem({text={"2";"李发";"123456789";"错误提示"} } ) } setMenu=function(){ var menuHelp = win.ui.popmenu(mainForm);//创建弹出菜单 menuHelp.add("关于",function(id){ var Winabout = mainForm.loadForm("\dlg\关于\about.aardio"); Winabout.show(); }) menuHelp.add("赞助",function(id){ var winZz = mainForm.loadForm("\dlg\赞助\zanzhu.aardio"); winZz.show(); }) menuHelp.add("退出",function(id){ mainForm.close() }) var menu = win.ui.menu(mainForm);//创建主菜单 menu.add('号码管理',popmenu1) menu.add('|') menu.add('身份证管理',popmenu2); menu.add('|') menu.add('日志管理',popmenu3); menu.add('|') menu.add('帮助',menuHelp) } /*}}*/ /*实名按钮{{*/ mainForm.kssm.oncommand = function(id,event){ mainForm.s1.text="实名中" mainForm.kssm.disabled=true; mainForm.listview3.clear() init2()//初始化标签 thread.set("start", true) win.invoke( function(mainForm,upInfoLis){ import win; import HJDL; import fsys; import console; import uConfig; var user = thread.get("user"); if(!user){ win.msgbox("登录状态异常。") mainForm.kssm.disabled=false; return ; } if(mainForm.listview.getItemText(1,2)=="" || mainForm.listview2.getItemText(1,2)==""){ win.msgbox("号码或证件信息列表不能为空。") mainForm.kssm.disabled=false; return ; } mainForm.s1.text="提交实名中" var session =thread.get("session") ; var openPath = thread.get("openPath"); var HJ = HJDL() var k = 1; for(i=1;mainForm.listview.count;1){ if(!thread.get("start")){ return }; //停止实名 var callState = mainForm.listview.getItemText(i,3); var nameDir = mainForm.listview2.getItemText(1,10); var nameOcr = mainForm.listview2.getItemText(1,2); if(callState=="未登记" || callState=="认证中"){ if(mainForm.listview2.count==0){ return }; //超过证件数量 mainForm.listview.setItemText("认证中",i,3) var cardDATA = { name = mainForm.listview2.getItemText(1,2); cardNo = mainForm.listview2.getItemText(1,3); gender = mainForm.listview2.getItemText(1,4); nation = mainForm.listview2.getItemText(1,5); birthday = mainForm.listview2.getItemText(1,6); address = mainForm.listview2.getItemText(1,7); authortity = mainForm.listview2.getItemText(1,8); validate = mainForm.listview2.getItemText(1,9) } var sysDATA = { user = user; phone = mainForm.listview.getItemText(i,2); picFront = openPath+nameDir+"\z.jpg";//name目录下的证件 picBack = openPath+nameDir+"\b.jpg";//name目录下的证件 picBody = openPath+nameDir+"\h.jpg";//name目录下的半身照片 picHt1 = openPath+nameDir+"\h1.jpg";//name目录下的活体1照片 picHt2 = openPath+nameDir+"\h2.jpg";//name目录下的活体2照片 } cardDATA = web.json.strip(cardDATA); sysDATA = web.json.strip(sysDATA); mainForm.s5.text = cardDATA.cardNo//标签显示 当前实名身份证 //提交开始---------------------------------------------------------------------------------------- var flag,data = HJ.uploadPicHT(session, sysDATA) if(!flag){ uConfig.saveIni(sysDATA.user,sysDATA.phone) mainForm.listview.setItemText(data,i,3) mainForm.listview3.addItem({text={"【号码】";sysDATA.phone;data}})//错误日志输出 continue } var flag2,msg = HJ.sumbitHT(session, sysDATA.phone, cardDATA, data ); if(flag2){ uConfig.saveIni(sysDATA.user,sysDATA.phone) mainForm.listview.setItemText("已实名",i,3) mainForm.listview3.addItem({text={cardDATA.name;cardDATA.cardNo;"手机号："+sysDATA.phone+"，实名成功"}}) mainForm.s4.text = k //已实名标签 string.save("\成功记录.txt",sysDATA.phone + "----" + cardDATA.name + "----" + cardDATA.cardNo + '\r\n' ,true) k++ }else { mainForm.listview.setItemText("失败",i,3) mainForm.listview3.addItem({text={"【号码】";sysDATA.phone; msg}})//错误日志输出 //sif(msg!="网络异常。"){ upInfoLis(mainForm) }; //i--; } upInfoLis(mainForm); //删除认证过的资料 //提交结束---------------------------------------------------------------------------------------- } //未登记判断 }//实名循环体 },mainForm,upInfoLis//线程函数 ) win.msgboxErr("实名结束。"); mainForm.s1.text="实名结束" mainForm.kssm.disabled=false; } /*}}*/ //停止实名 mainForm.tzsm.oncommand = function(id,event){ thread.set("start", false) mainForm.s1.text="未启动" mainForm.kssm.disabled=false; } init()//初始化标签 setPhoneLis()//显示手机列表框 setCardLis()//显示身份证列表框 setLogLis()//显示Log信息 setMenu()//显示菜单栏 mainForm.show(); return win.loopMessage();
